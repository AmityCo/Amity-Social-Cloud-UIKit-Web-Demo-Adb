stages:
  - audit
  - test
  - build_pr
  - deploy_pr
  - notice_pr
  - trash_pr
  - build
  - deploy

build_pr:
  image: node:12.18
  stage: build_pr
  script:
    - npm i -g npm
    - npm ci
    - npm run storybook:build
  artifacts:
    paths:
      - ./storybook-build
  only:
    - merge_requests

deploy_pr:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy_pr
  dependencies:
    - build_pr
  script:
    - aws s3 sync --delete ./storybook-build s3://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_IID
  environment:
    name: staging/pr$CI_MERGE_REQUEST_ID
    url: http://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_IID
    on_stop: trash_pr
  only:
    - merge_requests

notice_pr:
  image: alpine:latest
  stage: notice_pr
  dependencies:
    - deploy_pr
  script:
    - apk --no-cache add curl
    - 'curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" -X POST https://gitlab.com/api/v4/projects/$CI_MERGE_REQUEST_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes -d "body=http://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_IID/"'
    - 'echo $CI_MERGE_REQUEST_TITLE'
    - 'echo TODO Send message to eko-green: http://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_IID/'
  only:
    - merge_requests

trash_pr:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: trash_pr
  when: manual
  script:
    - aws s3 rm --recursive s3://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_ID/
  environment:
    name: staging/pr$CI_MERGE_REQUEST_ID
    url: http://ui-kit.staging.ekomedia.technology/pr$CI_MERGE_REQUEST_IID
    action: stop
  only:
    - develop
    - merge_requests

audit:
  image: node:12.18
  stage: audit
  script:
    - npm i -g npm
    - npm ci
    - npm audit
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /(?i)^v[0-9]+\.[0-9]+\.[0-9]+(-rc.[0-9]+)?$/'

unit:
  image: node:12.18
  stage: test
  script:
    - npm i -g npm
    - npm ci
    - npm run test
  rules:
    - if: '$CI_COMMIT_TAG =~ /(?i)^v[0-9]+\.[0-9]+\.[0-9]+(-rc.[0-9]+)?$/'

build:
  image: node:12.18
  stage: build
  script:
    - npm i -g npm
    - npm ci
    - npm run build
  rules:
    - if: '$CI_COMMIT_TAG =~ /(?i)^v[0-9]+\.[0-9]+\.[0-9]+(-rc.[0-9]+)?$/'
  artifacts:
    paths:
      - ./

publish:
  image: node:12.18
  stage: deploy
  script:
    - npm i -g npm
    - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
    - npm publish
  rules:
    - if: '$CI_COMMIT_TAG =~ /(?i)^v[0-9]+\.[0-9]+\.[0-9]+(-rc.[0-9]+)?$/'
